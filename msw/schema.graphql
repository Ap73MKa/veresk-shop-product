# =============================================================
# ROOT OPERATIONS
# =============================================================

schema {
  query: Query
  subscription: Subscription
}

type Query {
  productById(id: ID!): Product
  productBySlug(slug: String!): Product
  products(
    filters: ProductFilters
    sort: ProductSort
    pagination: Pagination
  ): ProductConnection!

  category(slug: String!): Category
  categories(
    filters: CategoryFilters
    pagination: Pagination
  ): CategoryConnection!
}

type Subscription {
  product(id: ID!): Product
}

# =============================================================
# PAGINATION & FILTERS
# =============================================================

input Pagination {
  limit: Int = 20
  offset: Int = 0
  after: String
}

type PageInfo {
  hasNextPage: Boolean!
  hasPreviousPage: Boolean!
  startCursor: String
  endCursor: String
}

input CategoryFilters {
  parentId: ID
  search: String
}

type CategoryConnection {
  edges: [CategoryEdge!]!
  pageInfo: PageInfo!
}

type CategoryEdge {
  node: Category!
  cursor: String!
}

type ProductConnection {
  edges: [ProductEdge!]!
  pageInfo: PageInfo!
}

type ProductEdge {
  node: Product!
  cursor: String!
}

input ProductFilters {
  categorySlug: String
  search: String
  minPrice: Float
  maxPrice: Float
  attributes: [AttributeFilter!]
}

input AttributeFilter {
  code: String!
  value: String!
}

enum ProductSort {
  NAME_ASC
  NAME_DESC
  PRICE_ASC
  PRICE_DESC
  RATING_DESC
  CREATED_AT_DESC
}

# =============================================================
# CORE ENTITIES
# =============================================================

type Product {
  id: ID!
  slug: String!
  name: String!
  partNumber: Int!

  # Pricing
  price: Price!
  discount: PriceChange
  installment: Installment

  # Content
  info: String!
  description: String!
  warranty: String!

  # Metadata
  rating: Float!
  isFreeDelivery: Boolean!
  extraTags: [Image!]

  # Configurable
  attributes: [Attribute!]!

  # Media & Documents
  systemGallery: [GalleryItem!]!
  userGallery: [GalleryItem!]
  manuals: [Link!]!

  # Relations
  collection: Link
  reviews: [Review!]!
  questions: [Question!]!
  similarProducts: [Product!]!
  alsoProducts: [Product!]!
  collectionProducts: [Product!]!
  searched: [Link!]!
}

type Category {
  id: ID!
  slug: String!
  name: String!
  description: String!
  media: Media

  # Hierarchy (non-recursive)
  parentId: ID
  parent: Category
  children: [Category!]!

  products(
    filters: ProductFilters
    sort: ProductSort
    pagination: Pagination
  ): ProductConnection!
}

# =============================================================
# PRICING
# =============================================================
type Price {
  list: Money!
  net: Money!
}

type Money {
  amount: Float!
  currencyCode: CurrencyCode!
}

enum CurrencyCode {
  RUB
  USD
  EUR
}

union PriceChange = AbsolutePriceChange | PercentPriceChange

type AbsolutePriceChange {
  amount: Money!
}

type PercentPriceChange {
  percent: Int!
}

# =============================================================
# MEDIA
# =============================================================

type GalleryItem {
  media: Media!
  order: Int!
}

union Media = Image | Video

type Image {
  src: String!
  alt: String
  width: Int
  height: Int
}

type Video {
  source: [VideoSource!]!
}

type VideoSource {
  src: String!
  type: String! # "mp4", "webm", etc.
}

# =============================================================
# ATTRIBUTES
# =============================================================

interface Attribute {
  id: ID!
  code: String!
  name: String!
  required: Boolean!
}

type DimensionAttribute implements Attribute {
  id: ID!
  code: String!
  name: String!
  required: Boolean!
  options: [DimensionOption!]!
}

type SelectAttribute implements Attribute {
  id: ID!
  code: String!
  name: String!
  required: Boolean!
  options: [SelectOption!]!
}

type MultiSelectAttribute implements Attribute {
  id: ID!
  code: String!
  name: String!
  required: Boolean!
  options: [MultiSelectOption!]!
}

type ColorAttribute implements Attribute {
  id: ID!
  code: String!
  name: String!
  required: Boolean!
  options: [ColorOption!]!
}

type VariantAttribute implements Attribute {
  id: ID!
  code: String!
  name: String!
  required: Boolean!
  compartments: [Compartment!]!
}

type EquipmentAttribute implements Attribute {
  id: ID!
  code: String!
  name: String!
  required: Boolean!
  options: [MultiSelectOption!]!
}

type BooleanAttribute implements Attribute {
  id: ID!
  code: String!
  name: String!
  required: Boolean!
  value: Boolean!
  addedPrice: PriceChange
}

type NumberAttribute implements Attribute {
  id: ID!
  code: String!
  name: String!
  required: Boolean!
  value: Float!
  min: Float!
  max: Float!
  step: Float!
  unit: String!
  addedPrice: PriceChange
}

# =============================================================
# OPTIONS
# =============================================================

interface Option {
  id: ID!
  value: String!
  display: String!
}

type DimensionOption implements Option {
  id: ID!
  value: String!
  display: String!
  selected: Boolean!
  unit: DimensionUnit!
}

enum DimensionUnit {
  M
  CM
  MM
}

type SelectOption implements Option {
  id: ID!
  value: String!
  display: String!
  selected: Boolean!
  description: String!
  media: Media!
  order: Int!
  addedPrice: PriceChange
}

type MultiSelectOption implements Option {
  id: ID!
  value: String!
  display: String!
  quantity: Int!
  description: String!
  minQuantity: Int!
  maxQuantity: Int!
  media: Media!
  order: Int!
  addedPrice: PriceChange
}

type ColorOption implements Option {
  id: ID!
  value: String!
  display: String!
  selected: Boolean!
  description: String!
  media: Media!
  order: Int!
  addedPrice: PriceChange
}

# =============================================================
# VARIANTS
# =============================================================

type Compartment {
  id: ID!
  size: Float!
  unit: String!
  order: Int!
  options: [VariantOption!]!
}

type VariantOption implements Option {
  id: ID!
  value: String!
  display: String!
  media: Media!
  order: Int!
  addedPrice: PriceChange!
  description: String!
  minQuantity: Int!
  maxQuantity: Int!
  quantity: Int!
}

# =============================================================
# COMMUNICATION
# =============================================================

interface Communication {
  id: ID!
  userId: ID!
  userName: String!
  date: Date!
  text: String!
  media: [Media!]
}

type Review implements Communication {
  id: ID!
  userId: ID!
  userName: String!
  date: Date!
  text: String!
  media: [Media!]
  rating: Rating!
}

type Question implements Communication {
  id: ID!
  userId: ID!
  userName: String!
  date: Date!
  text: String!
  media: [Media!]
  rating: Rating
}

enum Rating {
  ONE
  TWO
  THREE
  FOUR
  FIVE
}

# =============================================================
# MISC
# =============================================================

type Link {
  url: String!
  text: String!
}

scalar Date

type Installment {
  payment: Money!
  period: Period!
}

type Period {
  length: Int!
  unit: PeriodUnit!
}

enum PeriodUnit {
  DAY
  WEEK
  MONTH
  YEAR
}
